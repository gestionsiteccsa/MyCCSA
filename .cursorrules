# R√®gles Cursor pour le projet MyCCSA - Django

## Contexte du projet

- **Type** : Application web m√©tier Django
- **H√©bergement** : Site mutualis√© o2switch (contraintes : pas de serveur d√©di√©, pas de Redis/Memcached par d√©faut)
- **Base de donn√©es** : PostgreSQL
- **Frontend** : Tailwind CSS 4.1 (CDN) + Vue.js
- **Performance cible** : Lighthouse 90+
- **Accessibilit√©** : WCAG AAA
- **Langue** : Fran√ßais uniquement
- **Tests** : Tests complets (unitaires, int√©gration, fonctionnels)
- **CI/CD** : GitHub Actions
- **Qualit√© de code** : Flake8

## üî¥ R√®gles CRITIQUES (bloquantes)

Ces r√®gles sont **NON-N√âGOCIABLES** et peuvent causer des bugs graves ou des failles de s√©curit√© :

### 1. **JAMAIS de requ√™tes dans les boucles ‚Üí N+1 queries**
```python
# ‚ùå CRITIQUE - Fait N requ√™tes !
for product in Product.objects.all():
    print(product.category.name)  # N queries !

# ‚úÖ BON - 1 seule requ√™te
products = Product.objects.select_related('category').all()
for product in products:
    print(product.category.name)
```

### 2. **TOUJOURS {% csrf_token %} dans les formulaires**
```html


    




    {% csrf_token %}
    

```

### 3. **JAMAIS utiliser |safe sans validation stricte**
```django
{# ‚ùå CRITIQUE - Faille XSS ! #}
{{ user_input|safe }}

{# ‚úÖ BON #}
{{ user_input }}  {# √âchapp√© automatiquement #}
```

### 4. **JAMAIS de secrets dans le code**
```python
# ‚ùå CRITIQUE - Secret expos√© !
SECRET_KEY = "django-insecure-abc123"

# ‚úÖ BON
import os
SECRET_KEY = os.environ.get('SECRET_KEY')
```

### 5. **JAMAIS de SQL brut avec donn√©es utilisateur**
```python
# ‚ùå CRITIQUE - Injection SQL !
query = f"SELECT * FROM products WHERE name = '{user_input}'"

# ‚úÖ BON
Product.objects.filter(name=user_input)
```

---

## üü° R√®gles IMPORTANTES (√† respecter)

Ces r√®gles sont essentielles pour la qualit√© du projet :

1. ‚úÖ Tests complets avant chaque commit
2. ‚úÖ Flake8 sans erreurs
3. ‚úÖ Accessibilit√© WCAG AAA
4. ‚úÖ `select_related()`/`prefetch_related()` syst√©matiques
5. ‚úÖ Images avec `loading="lazy"` sous la ligne de flottaison
6. ‚úÖ Migrations test√©es avant d√©ploiement
7. ‚úÖ Docstrings pour toutes les fonctions complexes
8. ‚úÖ Validation stricte des formulaires

---

## ‚úÖ Checklist pre-commit

V√©rifier **syst√©matiquement** avant chaque commit :

```bash
# 1. Linting
[ ] flake8 . --max-line-length=88

# 2. Tests
[ ] python manage.py test

# 3. Migrations
[ ] python manage.py makemigrations --dry-run --check

# 4. Code quality
[ ] Pas de print() ou console.log() oubli√©s
[ ] Pas de secrets/tokens dans le code
[ ] Docstrings pr√©sentes sur fonctions complexes

# 5. Performance
[ ] select_related()/prefetch_related() utilis√©s
[ ] Images avec loading="lazy" si appropri√©
[ ] Pas de requ√™tes dans les boucles

# 6. S√©curit√©
[ ] {% csrf_token %} dans tous les formulaires POST
[ ] Validation des donn√©es utilisateur
[ ] Pas de |safe sans validation

# 7. Accessibilit√©
[ ] alt sur toutes les images
[ ] labels sur tous les champs de formulaire
[ ] Navigation clavier fonctionnelle
```

---

## ‚ö†Ô∏è Anti-patterns Django √† √©viter

### ‚ùå 1. Requ√™tes dans les templates
```django
{# ‚ùå MAUVAIS - N+1 queries #}
{% for product in products %}
    {{ product.category.name }}
    {% for tag in product.tags.all %}  {# Requ√™te par produit ! #}
        {{ tag.name }}
    {% endfor %}
{% endfor %}
```

```python
# ‚úÖ BON - Pr√©charger dans la vue
products = Product.objects.select_related('category').prefetch_related('tags').all()
```

### ‚ùå 2. Logique m√©tier dans les vues
```python
# ‚ùå MAUVAIS
def create_order(request):
    order = Order.objects.create(user=request.user)
    total = 0
    for item in cart_items:
        total += item.price * item.quantity
    order.total = total
    order.save()
    send_confirmation_email(order)
    update_inventory(order)
    return redirect('order_detail', pk=order.pk)
```

```python
# ‚úÖ BON - Utiliser un service layer
# services/order_service.py
class OrderService:
    @staticmethod
    def create_order(user, cart_items):
        with transaction.atomic():
            order = Order.objects.create(user=user)
            order.calculate_total(cart_items)
            order.save()
            OrderService._send_confirmation(order)
            OrderService._update_inventory(order)
        return order

# views.py
def create_order(request):
    order = OrderService.create_order(request.user, cart_items)
    return redirect('order_detail', pk=order.pk)
```

### ‚ùå 3. Requ√™tes dans les boucles
```python
# ‚ùå MAUVAIS
for category in Category.objects.all():
    products = Product.objects.filter(category=category)  # N queries !
    print(f"{category.name}: {products.count()}")
```

```python
# ‚úÖ BON
from django.db.models import Count
categories = Category.objects.annotate(product_count=Count('products'))
for category in categories:
    print(f"{category.name}: {category.product_count}")
```

### ‚ùå 4. Pas de validation des formulaires
```python
# ‚ùå MAUVAIS
def create_product(request):
    if request.method == 'POST':
        name = request.POST.get('name')
        price = request.POST.get('price')
        Product.objects.create(name=name, price=price)  # Pas de validation !
```

```python
# ‚úÖ BON
class ProductForm(forms.ModelForm):
    class Meta:
        model = Product
        fields = ['name', 'price']
    
    def clean_price(self):
        price = self.cleaned_data['price']
        if price < 0:
            raise forms.ValidationError("Le prix doit √™tre positif")
        return price

def create_product(request):
    if request.method == 'POST':
        form = ProductForm(request.POST)
        if form.is_valid():
            form.save()
```

### ‚ùå 5. Utilisation abusive de .save()
```python
# ‚ùå MAUVAIS
for product in Product.objects.filter(status='draft'):
    product.status = 'published'
    product.save()  # N saves !
```

```python
# ‚úÖ BON
Product.objects.filter(status='draft').update(status='published')  # 1 query !
```

---

## üéØ Contexte du projet

- **Type** : Application web m√©tier Django
- **H√©bergement** : Site mutualis√© o2switch (contraintes : pas de serveur d√©di√©, pas de Redis/Memcached par d√©faut)
- **Base de donn√©es** : PostgreSQL
- **Frontend** : Tailwind CSS 4.1 (CDN) + Vue.js
- **Performance cible** : Lighthouse 90+
- **Accessibilit√©** : WCAG AAA
- **Langue** : Fran√ßais uniquement
- **Tests** : Tests complets (unitaires, int√©gration, fonctionnels)
- **CI/CD** : GitHub Actions
- **Qualit√© de code** : Flake8

---

## üìê Conventions de nommage

### Mod√®les
- **Singulier** : `Product`, `Category`, `Order`
- **PascalCase**

### Apps
- **Pluriel** : `products`, `orders`, `users`
- **snake_case**

### Vues
- **Verbe + nom** : `create_product`, `ProductListView`
- **snake_case** pour functions, **PascalCase** pour classes

### URLs
- **Pluriel** : `/products/`, `/orders/`
- **kebab-case** : `/product-detail/`
- **Noms** : `product_list`, `order_detail`

### Templates
- **snake_case** : `product_list.html`, `order_detail.html`

### Variables
- **snake_case** : `user_email`, `total_price`
- Descriptives : `product_list` plut√¥t que `pl`

### Constantes
- **UPPER_SNAKE_CASE** : `MAX_FILE_SIZE`, `STATUS_PUBLISHED`

---

## 1. Architecture Django

### Structure modulaire
- Toujours cr√©er de nouvelles apps avec `python manage.py startapp` pour chaque fonctionnalit√© m√©tier distincte
- Chaque app doit avoir une responsabilit√© unique et bien d√©finie
- Organiser les apps par domaine m√©tier, pas par type technique (ex: `users`, `products`, `orders` plut√¥t que `models`, `views`)

### S√©paration des responsabilit√©s
- **Models** : D√©finir uniquement la structure de donn√©es et les m√©thodes m√©tier li√©es aux donn√©es
- **Views** : Utiliser des class-based views (CBV) quand appropri√©, function-based views pour les cas simples
- **Forms** : Cr√©er des classes Form s√©par√©es dans `forms.py` pour chaque formulaire
- **Utils** : Cr√©er un fichier `utils.py` dans chaque app pour les fonctions utilitaires sp√©cifiques √† l'app
- **Services** : Cr√©er un dossier `services/` pour la logique m√©tier complexe qui ne doit pas √™tre dans les views

### Configuration
- Utiliser des variables d'environnement pour toutes les configurations sensibles (SECRET_KEY, DATABASE_URL, etc.)
- Cr√©er un fichier `.env.example` avec tous les param√®tres n√©cessaires
- Utiliser `django-environ` ou `python-decouple` pour g√©rer les variables d'environnement
- S√©parer les settings en `base.py`, `development.py`, `production.py` si n√©cessaire

### URLs et routing
- Utiliser `include()` pour organiser les URLs par app
- Nommer toutes les URLs avec des noms explicites : `path('detail/<int:pk>/', views.detail, name='product_detail')`
- √âviter les URLs trop profondes (max 3-4 niveaux)

---

## 2. Optimisation SQL et requ√™tes

### 2.1 √âviter les N+1 queries

#### select_related() pour ForeignKey et OneToOneField
```python
# ‚ùå MAUVAIS - N+1 queries
products = Product.objects.all()
for product in products:
    print(product.category.name)  # 1 query par produit !

# ‚úÖ BON - 1 seule requ√™te
products = Product.objects.select_related('category').all()
for product in products:
    print(product.category.name)
```

#### prefetch_related() pour ManyToMany et relations inverses
```python
# ‚ùå MAUVAIS - N+1 queries
products = Product.objects.all()
for product in products:
    for tag in product.tags.all():  # 1 query par produit !
        print(tag.name)

# ‚úÖ BON - 2 requ√™tes au total
products = Product.objects.prefetch_related('tags').all()
for product in products:
    for tag in product.tags.all():
        print(tag.name)
```

#### Combiner select_related() et prefetch_related()
```python
# ‚úÖ BON - Optimisation compl√®te
products = Product.objects.select_related(
    'category', 
    'vendor'
).prefetch_related(
    'tags',
    'reviews'
).all()
```

### 2.2 Optimisation des champs

#### only() - Charger uniquement les champs n√©cessaires
```python
# ‚úÖ BON - charge uniquement name et price
products = Product.objects.only('name', 'price').all()
```

#### defer() - Exclure les champs lourds
```python
# ‚úÖ BON - exclut description et content
products = Product.objects.defer('description', 'content').all()
```

#### values() et values_list() - Dictionnaires ou tuples
```python
# ‚úÖ BON - retourne des dicts
products = Product.objects.values('id', 'name', 'price')

# ‚úÖ BON - retourne des tuples
product_ids = Product.objects.values_list('id', flat=True)
```

### 2.3 Annotations et agr√©gations

#### annotate() - Ajouter des champs calcul√©s
```python
# ‚úÖ BON - Calcul en base de donn√©es
from django.db.models import Count, Avg

categories = Category.objects.annotate(
    product_count=Count('products'),
    avg_price=Avg('products__price')
)

# ‚ùå MAUVAIS - Calcul en Python (N+1)
categories = Category.objects.all()
for cat in categories:
    cat.product_count = cat.products.count()
```

#### aggregate() - Calculer sur tout le QuerySet
```python
from django.db.models import Sum, Avg

# ‚úÖ BON
stats = Product.objects.aggregate(
    total_price=Sum('price'),
    average_price=Avg('price')
)
# {'total_price': 1500.00, 'average_price': 50.00}
```

### 2.4 Index et performances

#### Ajouter des index sur les champs fr√©quents
```python
class Product(models.Model):
    name = models.CharField(max_length=200, db_index=True)
    slug = models.SlugField(unique=True, db_index=True)
    created_at = models.DateTimeField(auto_now_add=True, db_index=True)
```

#### Index composites
```python
class Product(models.Model):
    # ...
    
    class Meta:
        indexes = [
            models.Index(fields=['category', 'status']),
            models.Index(fields=['-created_at']),
            models.Index(fields=['name', 'category']),
        ]
```

### 2.5 Op√©rations avanc√©es

#### exists() au lieu de count()
```python
# ‚úÖ BON - Plus rapide
if Product.objects.filter(category=cat).exists():
    ...

# ‚ùå MAUVAIS - Compte tous les r√©sultats
if Product.objects.filter(category=cat).count() > 0:
    ...
```

#### F() pour les op√©rations sur les champs
```python
from django.db.models import F

# ‚úÖ BON - incr√©mente directement en DB
Product.objects.filter(id=1).update(views=F('views') + 1)

# ‚ùå MAUVAIS - charge en m√©moire puis sauvegarde
product = Product.objects.get(id=1)
product.views += 1
product.save()
```

#### Q() pour les requ√™tes complexes
```python
from django.db.models import Q

# ‚úÖ BON - requ√™te complexe
products = Product.objects.filter(
    Q(name__icontains='test') | Q(description__icontains='test'),
    Q(status='published') & Q(price__gte=10)
)
```

#### Subquery et OuterRef
```python
from django.db.models import OuterRef, Subquery

latest_reviews = Review.objects.filter(
    product=OuterRef('pk')
).order_by('-created_at')[:1]

products = Product.objects.annotate(
    latest_review_text=Subquery(latest_reviews.values('text'))
)
```

#### Prefetch personnalis√©
```python
from django.db.models import Prefetch

published_reviews = Review.objects.filter(status='published')
products = Product.objects.prefetch_related(
    Prefetch('reviews', queryset=published_reviews, to_attr='published_reviews_list')
)
```

#### select_for_update() pour locking
```python
from django.db import transaction

@transaction.atomic
def update_inventory(product_id, quantity):
    product = Product.objects.select_for_update().get(id=product_id)
    product.inventory -= quantity
    product.save()
```

### 2.6 Bulk operations

#### bulk_create() - Cr√©er plusieurs objets
```python
# ‚ùå MAUVAIS - N insertions
for name in product_names:
    Product.objects.create(name=name)

# ‚úÖ BON - 1 insertion
products = [Product(name=name) for name in product_names]
Product.objects.bulk_create(products)
```

#### bulk_update() - Mettre √† jour plusieurs objets
```python
products = Product.objects.filter(category=old_category)
for product in products:
    product.category = new_category
Product.objects.bulk_update(products, ['category'])
```

#### update() sur QuerySet
```python
# ‚ùå MAUVAIS - N updates
for product in Product.objects.filter(status='draft'):
    product.status = 'published'
    product.save()

# ‚úÖ BON - 1 update
Product.objects.filter(status='draft').update(status='published')
```

#### iterator() pour grandes listes
```python
# ‚úÖ BON pour grandes listes en lecture seule
for product in Product.objects.all().iterator():
    process(product)
```

---

## 3. Performance HTML/Frontend

### 3.1 Optimisation des images

#### Lazy loading obligatoire
```html


```

#### Formats modernes avec fallback
```html

  
  

```

#### Dimensions d√©finies (√©viter layout shift)
```html

```

#### srcset pour images responsives
```html

```

### 3.2 Optimisation des scripts

#### defer pour scripts non critiques
```html

```

#### async pour scripts ind√©pendants
```html

```

#### Vue.js avec defer
```html

```

### 3.3 Tailwind CSS 4.1

#### Utilisation CDN
```html

```

#### Classes utilitaires prioritaires
- Utiliser les classes Tailwind plut√¥t que du CSS custom
- `@apply` uniquement pour patterns r√©p√©titifs
- √âviter les classes redondantes

### 3.4 WhiteNoise pour fichiers statiques

#### Configuration settings.py
```python
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware',  # Apr√®s SecurityMiddleware
    # ... autres middlewares
]

STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'
STATIC_ROOT = BASE_DIR / 'staticfiles'
```

#### Collecte des fichiers
```bash
python manage.py collectstatic --noinput
```

### 3.5 Minification et compression

- Utiliser `django-compressor` ou `django-minify-html`
- Activer Gzip/Brotli au niveau serveur
- Minifier CSS/JS en production

### 3.6 Performance g√©n√©rale

- Limiter les render_block dans les templates
- Utiliser `{% cache %}` pour parties statiques
- Combiner CSS/JS si possible
- Fonts syst√®me ou fonts optimis√©es (subset)
- Pr√©charger relations avant templates :

```python
# ‚úÖ BON
products = Product.objects.select_related('category').prefetch_related('tags').all()
return render(request, 'products.html', {'products': products})
```

---

## 4. Responsive Design

### Mobile-first avec Tailwind CSS

#### Approche mobile-first
```html


  Texte responsive

```

### Breakpoints Tailwind
- `sm`: 640px
- `md`: 768px
- `lg`: 1024px
- `xl`: 1280px
- `2xl`: 1536px

### Images responsives
```html

```

### Tests responsive
- Tester mobile, tablette, desktop
- Utiliser DevTools pour tester breakpoints
- V√©rifier lisibilit√© sur tous appareils

---

## 5. Accessibilit√© (WCAG AAA)

### 5.1 Structure s√©mantique HTML5

#### √âl√©ments s√©mantiques
```html
, , , , , , 
```

#### Headings hi√©rarchiques
```html
Page principale
Section 1
Sous-section

```

### 5.2 Attributs ARIA

#### aria-label pour √©l√©ments interactifs
```html

  &times;

```

#### aria-describedby pour descriptions
```html

Votre email ne sera jamais partag√©
```

#### aria-live pour r√©gions dynamiques
```html

```

#### aria-hidden pour √©l√©ments d√©coratifs
```html
‚ú®
```

### 5.3 Navigation au clavier

- Tous √©l√©ments interactifs accessibles au clavier
- `tabindex="0"` pour √©l√©ments focusables personnalis√©s
- `tabindex="-1"` pour exclure de la tabulation
- Focus visible : `focus:outline-none focus:ring-2 focus:ring-blue-500`

### 5.4 Contraste des couleurs (WCAG AAA)

#### Ratios minimum
- Texte normal : **7:1**
- Texte large (18pt+ ou 14pt+ gras) : **4.5:1**
- √âl√©ments non-textuels : **3:1**

#### Ne pas utiliser couleur seule
```html

Erreur



  ‚ö†Ô∏è Erreur

```

### 5.5 Formulaires accessibles

#### Labels obligatoires
```html
Email

```

#### Champs obligatoires
```html

```

#### Messages d'erreur
```html

Email invalide
```

#### Groupes de champs
```html

  Informations de contact
  
  

```

### 5.6 Support lecteurs d'√©cran

#### Roles appropri√©s
```html
Message important
Chargement termin√©

```

#### aria-expanded pour expansibles
```html
Menu
...
```

### 5.7 Autres bonnes pratiques

#### Alternatives textuelles
```html

```

#### Images d√©coratives
```html

```

#### Respecter prefers-reduced-motion
```css
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}
```

---

## 6. S√©curit√©

### 6.1 Protection CSRF

#### Toujours utiliser csrf_token
```html

  {% csrf_token %}
  ...

```

#### Configuration production
```python
CSRF_TRUSTED_ORIGINS = ['https://votredomaine.com']
```

### 6.2 Protection XSS

#### √âchappement automatique
```django

{{ user_input }}


{{ user_input|safe }}
```

#### mark_safe() uniquement pour contenu de confiance
```python
from django.utils.safestring import mark_safe

# Uniquement apr√®s validation stricte
safe_html = mark_safe(validated_content)
```

### 6.3 Protection injection SQL

#### Utiliser l'ORM Django
```python
# ‚ùå MAUVAIS
query = f"SELECT * FROM products WHERE name = '{user_input}'"

# ‚úÖ BON
Product.objects.filter(name=user_input)
```

#### SQL brut avec param√®tres
```python
# ‚úÖ BON si SQL brut n√©cessaire
from django.db import connection
with connection.cursor() as cursor:
    cursor.execute("SELECT * FROM products WHERE name = %s", [user_input])
```

### 6.4 Rate limiting

#### Impl√©menter rate limiting
```python
from django.core.cache import cache
from django.http import HttpResponseTooManyRequests

def rate_limit_view(request):
    key = f'rate_limit_{request.META.get("REMOTE_ADDR")}'
    count = cache.get(key, 0)
    if count >= 10:
        return HttpResponseTooManyRequests()
    cache.set(key, count + 1, 60)
    # ... traitement normal
```

### 6.5 Content Security Policy (CSP)

```python
SECURE_CONTENT_SECURITY_POLICY = {
    'default-src': "'self'",
    'script-src': "'self' 'unsafe-inline' https://cdn.jsdelivr.net",
    'style-src': "'self' 'unsafe-inline' https://cdn.jsdelivr.net",
    'img-src': "'self' data: https:",
}
```

### 6.6 Validation stricte des entr√©es

#### Validation dans les forms
```python
class ProductForm(forms.ModelForm):
    def clean_price(self):
        price = self.cleaned_data['price']
        if price < 0:
            raise forms.ValidationError("Le prix doit √™tre positif")
        return price
```

#### Validators Django
```python
from django.core.validators import MinValueValidator, MaxValueValidator

price = models.DecimalField(
    max_digits=10,
    decimal_places=2,
    validators=[MinValueValidator(0)]
)
```

### 6.7 Gestion s√©curis√©e des secrets

```python
# ‚ùå MAUVAIS
SECRET_KEY = "django-insecure-g4!ch..."

# ‚úÖ BON
import os
SECRET_KEY = os.environ.get('SECRET_KEY')
```

### 6.8 Configuration production s√©curis√©e

```python
# Production settings
SECURE_SSL_REDIRECT = True
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
SECURE_BROWSER_XSS_FILTER = True
X_FRAME_OPTIONS = 'DENY'
SECURE_HSTS_SECONDS = 31536000
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True

# Limiter taille uploads
FILE_UPLOAD_MAX_MEMORY_SIZE = 2621440  # 2.5 MB
DATA_UPLOAD_MAX_MEMORY_SIZE = 2621440
```


---
## DIVERS 
## 1. Architecture Django

### Structure modulaire
- Toujours cr√©er de nouvelles apps avec `python manage.py startapp` pour chaque fonctionnalit√© m√©tier distincte
- Chaque app doit avoir une responsabilit√© unique et bien d√©finie
- Organiser les apps par domaine m√©tier, pas par type technique (ex: `users`, `products`, `orders` plut√¥t que `models`, `views`)

### S√©paration des responsabilit√©s
- **Models** : D√©finir uniquement la structure de donn√©es et les m√©thodes m√©tier li√©es aux donn√©es
- **Views** : Utiliser des class-based views (CBV) quand appropri√©, function-based views pour les cas simples
- **Forms** : Cr√©er des classes Form s√©par√©es dans `forms.py` pour chaque formulaire
- **Utils** : Cr√©er un fichier `utils.py` dans chaque app pour les fonctions utilitaires sp√©cifiques √† l'app
- **Services** : Cr√©er un dossier `services/` pour la logique m√©tier complexe qui ne doit pas √™tre dans les views

### Configuration
- Utiliser des variables d'environnement pour toutes les configurations sensibles (SECRET_KEY, DATABASE_URL, etc.)
- Cr√©er un fichier `.env.example` avec tous les param√®tres n√©cessaires
- Utiliser `django-environ` ou `python-decouple` pour g√©rer les variables d'environnement
- S√©parer les settings en `base.py`, `development.py`, `production.py` si n√©cessaire

### URLs et routing
- Utiliser `include()` pour organiser les URLs par app
- Nommer toutes les URLs avec des noms explicites : `path('detail/<int:pk>/', views.detail, name='product_detail')`
- √âviter les URLs trop profondes (max 3-4 niveaux)

---

## 2. Optimisation SQL et requ√™tes

### √âviter les N+1 queries
- **TOUJOURS** utiliser `select_related()` pour les ForeignKey et OneToOneField :
  ```python
  # ‚úÖ BON
  products = Product.objects.select_related('category', 'vendor').all()
  
  # ‚ùå MAUVAIS
  products = Product.objects.all()  # Va faire N+1 queries
  ```

- **TOUJOURS** utiliser `prefetch_related()` pour les ManyToManyField et les relations inverses :
  ```python
  # ‚úÖ BON
  products = Product.objects.prefetch_related('tags', 'reviews').all()
  
  # ‚ùå MAUVAIS
  products = Product.objects.all()  # Va faire N+1 queries
  ```

### Limiter les champs charg√©s
- Utiliser `only()` pour charger uniquement les champs n√©cessaires :
  ```python
  # ‚úÖ BON - charge uniquement name et price
  products = Product.objects.only('name', 'price').all()
  ```

- Utiliser `defer()` pour exclure les champs lourds :
  ```python
  # ‚úÖ BON - exclut description et content
  products = Product.objects.defer('description', 'content').all()
  ```

### Annotations et agr√©gations
- Utiliser `annotate()` et `aggregate()` pour calculer dans la base de donn√©es plut√¥t qu'en Python :
  ```python
  # ‚úÖ BON
  from django.db.models import Count, Avg
  categories = Category.objects.annotate(product_count=Count('products'))
  
  # ‚ùå MAUVAIS
  categories = Category.objects.all()
  for cat in categories:
      cat.product_count = cat.products.count()  # N+1 queries
  ```

### Optimisations sp√©cifiques
- Utiliser `exists()` au lieu de `count()` quand on v√©rifie juste l'existence :
  ```python
  # ‚úÖ BON
  if Product.objects.filter(category=cat).exists():
      ...
  
  # ‚ùå MAUVAIS
  if Product.objects.filter(category=cat).count() > 0:
      ...
  ```

- Utiliser `get()` avec `DoesNotExist` plut√¥t que `filter().first()` quand on attend un seul r√©sultat :
  ```python
  # ‚úÖ BON
  try:
      product = Product.objects.get(pk=pk)
  except Product.DoesNotExist:
      ...
  
  # ‚ùå MAUVAIS (moins clair)
  product = Product.objects.filter(pk=pk).first()
  ```

### Index de base de donn√©es
- Ajouter `db_index=True` sur les champs fr√©quemment utilis√©s dans les filtres :
  ```python
  class Product(models.Model):
      name = models.CharField(max_length=200, db_index=True)
      slug = models.SlugField(unique=True, db_index=True)
      created_at = models.DateTimeField(auto_now_add=True, db_index=True)
  ```

- Utiliser `Meta.indexes` pour les index composites :
  ```python
  class Meta:
      indexes = [
          models.Index(fields=['category', 'status']),
          models.Index(fields=['-created_at']),
      ]
  ```

### √âviter les requ√™tes dans les boucles
- **JAMAIS** de requ√™tes dans les boucles :
  ```python
  # ‚ùå MAUVAIS
  for category in Category.objects.all():
      products = Product.objects.filter(category=category)  # N queries !
  
  # ‚úÖ BON
  categories = Category.objects.prefetch_related('products').all()
  for category in categories:
      products = category.products.all()  # Pas de nouvelle requ√™te
  ```

### Utilisation de QuerySet efficace
- Utiliser `iterator()` pour les grandes listes en lecture seule :
  ```python
  # ‚úÖ BON pour grandes listes
  for product in Product.objects.all().iterator():
      process(product)
  ```

- Utiliser `values()` ou `values_list()` pour obtenir uniquement les donn√©es n√©cessaires :
  ```python
  # ‚úÖ BON - retourne des dicts
  products = Product.objects.values('id', 'name', 'price')
  
  # ‚úÖ BON - retourne des tuples
  product_ids = Product.objects.values_list('id', flat=True)
  ```

### Expressions F() et Q()
- Utiliser `F()` pour les op√©rations sur les champs :
  ```python
  from django.db.models import F
  
  # ‚úÖ BON - incr√©mente directement en DB
  Product.objects.filter(id=1).update(views=F('views') + 1)
  
  # ‚ùå MAUVAIS - charge en m√©moire puis sauvegarde
  product = Product.objects.get(id=1)
  product.views += 1
  product.save()
  ```

- Utiliser `Q()` pour les requ√™tes complexes :
  ```python
  from django.db.models import Q
  
  # ‚úÖ BON - requ√™te complexe
  products = Product.objects.filter(
      Q(name__icontains='test') | Q(description__icontains='test'),
      Q(status='published') & Q(price__gte=10)
  )
  ```

### Subquery et OuterRef
- Utiliser `Subquery` et `OuterRef` pour les sous-requ√™tes :
  ```python
  from django.db.models import OuterRef, Subquery
  
  latest_reviews = Review.objects.filter(
      product=OuterRef('pk')
  ).order_by('-created_at')[:1]
  
  products = Product.objects.annotate(
      latest_review_text=Subquery(latest_reviews.values('text'))
  )
  ```

### Prefetch object avanc√©
- Utiliser `Prefetch` pour des prefetch_related personnalis√©s :
  ```python
  from django.db.models import Prefetch
  
  published_reviews = Review.objects.filter(status='published')
  products = Product.objects.prefetch_related(
      Prefetch('reviews', queryset=published_reviews, to_attr='published_reviews_list')
  )
  ```

### select_for_update() pour locking
- Utiliser `select_for_update()` pour le locking pessimiste :
  ```python
  from django.db import transaction
  
  @transaction.atomic
  def update_inventory(product_id, quantity):
      product = Product.objects.select_for_update().get(id=product_id)
      product.inventory -= quantity
      product.save()
  ```

---

## 3. Performance HTML/Frontend

### Optimisation des images
- **TOUJOURS** utiliser `loading="lazy"` pour les images en dessous de la ligne de flottaison :
  ```html
  <img src="image.jpg" alt="Description" loading="lazy">
  ```

- Utiliser des formats modernes (WebP) avec fallback :
  ```html
  <picture>
    <source srcset="image.webp" type="image/webp">
    <img src="image.jpg" alt="Description" loading="lazy">
  </picture>
  ```

- D√©finir les dimensions des images pour √©viter le layout shift :
  ```html
  <img src="image.jpg" alt="Description" width="800" height="600" loading="lazy">
  ```

- Utiliser `srcset` pour les images responsives :
  ```html
  <img srcset="image-400.jpg 400w, image-800.jpg 800w, image-1200.jpg 1200w"
       sizes="(max-width: 600px) 400px, (max-width: 1200px) 800px, 1200px"
       src="image-800.jpg" alt="Description" loading="lazy">
  ```

### Optimisation des scripts
- D√©ferrer les scripts non critiques avec `defer` :
  ```html
  <script src="analytics.js" defer></script>
  ```

- Utiliser `async` pour les scripts ind√©pendants :
  ```html
  <script src="widget.js" async></script>
  ```

- Charger Vue.js avec `defer` :
  ```html
  <script src="https://unpkg.com/vue@3/dist/vue.global.js" defer></script>
  ```

### Tailwind CSS 4.1
- Utiliser la version CDN comme sp√©cifi√© :
  ```html
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  ```

- Utiliser les classes utilitaires Tailwind plut√¥t que du CSS custom quand possible
- Utiliser `@apply` avec parcimonie et uniquement pour des patterns r√©p√©titifs
- Optimiser les classes Tailwind en √©vitant les classes redondantes

### WhiteNoise pour fichiers statiques
- Configurer WhiteNoise dans `settings.py` :
  ```python
  MIDDLEWARE = [
      'django.middleware.security.SecurityMiddleware',
      'whitenoise.middleware.WhiteNoiseMiddleware',  # Apr√®s SecurityMiddleware
      # ... autres middlewares
  ]
  
  STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'
  ```

- Collecter les fichiers statiques en production :
  ```bash
  python manage.py collectstatic --noinput
  ```

### Minification et compression
- Utiliser `django-compressor` ou `django-minify-html` pour la minification HTML
- Activer la compression Gzip/Brotli au niveau du serveur si possible
- Minifier les fichiers CSS et JS en production

### Performance g√©n√©rale
- √âviter les render_block trop nombreux dans les templates
- Utiliser `{% cache %}` pour les parties statiques des templates
- Limiter le nombre de requ√™tes HTTP (combiner les fichiers CSS/JS si possible)
- Utiliser des fonts syst√®me ou des fonts optimis√©es (subset)
- Pr√©charger les relations dans les vues avant de passer aux templates :
  ```python
  # ‚úÖ BON - Pr√©charger avant le template
  products = Product.objects.select_related('category').prefetch_related('tags').all()
  return render(request, 'products.html', {'products': products})
  ```

---

## 4. Responsive Design

### Mobile-first avec Tailwind CSS
- **TOUJOURS** commencer par le style mobile, puis ajouter les breakpoints pour les √©crans plus grands :
  ```html
  <div class="text-sm md:text-base lg:text-lg">
  ```

### Breakpoints Tailwind par d√©faut
- Utiliser les breakpoints standards de Tailwind :
  - `sm`: 640px
  - `md`: 768px
  - `lg`: 1024px
  - `xl`: 1280px
  - `2xl`: 1536px

### Images responsives
- Utiliser les classes Tailwind pour les images responsives :
  ```html
  <img src="image.jpg" alt="Description" class="w-full h-auto md:w-1/2 lg:w-1/3">
  ```

### Tests responsive
- Tester sur diff√©rentes tailles d'√©cran (mobile, tablette, desktop)
- Utiliser les outils de d√©veloppement du navigateur pour tester les breakpoints
- V√©rifier que le contenu reste lisible sur tous les appareils

---

## 5. Accessibilit√© (WCAG AAA)

### Structure s√©mantique HTML5
- Utiliser les √©l√©ments s√©mantiques appropri√©s :
  ```html
  <header>, <nav>, <main>, <article>, <section>, <aside>, <footer>
  ```

- Utiliser les headings hi√©rarchiquement (h1 ‚Üí h2 ‚Üí h3) :
  ```html
  <h1>Page principale</h1>
  <h2>Section 1</h2>
  <h3>Sous-section</h3>
  ```

### Attributs ARIA
- Ajouter `aria-label` pour les √©l√©ments interactifs sans texte visible :
  ```html
  <button aria-label="Fermer la modal">
    <span aria-hidden="true">&times;</span>
  </button>
  ```

- Utiliser `aria-describedby` pour lier les descriptions aux champs de formulaire :
  ```html
  <input id="email" aria-describedby="email-help">
  <div id="email-help">Votre email ne sera jamais partag√©</div>
  ```

- Utiliser `aria-live` pour les r√©gions dynamiques :
  ```html
  <div aria-live="polite" id="notifications"></div>
  ```

- Marquer les √©l√©ments d√©coratifs avec `aria-hidden="true"` :
  ```html
  <span aria-hidden="true">‚ú®</span>
  ```

### Navigation au clavier
- Tous les √©l√©ments interactifs doivent √™tre accessibles au clavier
- Utiliser `tabindex="0"` pour les √©l√©ments focusables personnalis√©s
- Utiliser `tabindex="-1"` pour les √©l√©ments qui ne doivent pas √™tre dans l'ordre de tabulation
- G√©rer le focus visible avec `focus:outline-none focus:ring-2 focus:ring-blue-500`

### Contraste des couleurs (WCAG AAA)
- Ratio de contraste minimum :
  - Texte normal : 7:1
  - Texte large (18pt+ ou 14pt+ gras) : 4.5:1
  - √âl√©ments non-textuels (boutons, etc.) : 3:1

- V√©rifier avec des outils comme WebAIM Contrast Checker
- Ne pas utiliser uniquement la couleur pour transmettre l'information :
  ```html
  <!-- ‚ùå MAUVAIS -->
  <span style="color: red">Erreur</span>
  
  <!-- ‚úÖ BON -->
  <span class="text-red-600" aria-label="Erreur">
    <span aria-hidden="true">‚ö†Ô∏è</span> Erreur
  </span>
  ```

### Formulaires accessibles
- **TOUJOURS** associer les labels aux champs :
  ```html
  <label for="email">Email</label>
  <input type="email" id="email" name="email" required>
  ```

- Utiliser `aria-required="true"` pour les champs obligatoires :
  ```html
  <input type="email" id="email" aria-required="true" required>
  ```

- Afficher les messages d'erreur avec `aria-describedby` :
  ```html
  <input id="email" aria-describedby="email-error" aria-invalid="true">
  <div id="email-error" role="alert">Email invalide</div>
  ```

- Utiliser `fieldset` et `legend` pour les groupes de champs :
  ```html
  <fieldset>
    <legend>Informations de contact</legend>
    <input type="email" name="email">
  </fieldset>
  ```

### Support des lecteurs d'√©cran
- Tester avec NVDA, JAWS, ou VoiceOver
- Utiliser `role` appropri√©s :
  ```html
  <div role="alert">Message important</div>
  <div role="status">Chargement termin√©</div>
  <nav role="navigation">
  ```

- Utiliser `aria-expanded` pour les √©l√©ments expansibles :
  ```html
  <button aria-expanded="false" aria-controls="menu">Menu</button>
  <div id="menu" hidden>...</div>
  ```

### Autres bonnes pratiques d'accessibilit√©
- Fournir des alternatives textuelles pour toutes les images :
  ```html
  <img src="chart.jpg" alt="Graphique montrant l'√©volution des ventes en 2024">
  ```

- Utiliser `alt=""` pour les images d√©coratives :
  ```html
  <img src="decoration.jpg" alt="" role="presentation">
  ```

- S'assurer que le contenu est compr√©hensible m√™me sans CSS
- √âviter les animations qui peuvent causer des probl√®mes (respecter `prefers-reduced-motion`) :
  ```css
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      transition-duration: 0.01ms !important;
    }
  }
  ```

---

## 6. S√©curit√©

### Protection CSRF
- **TOUJOURS** utiliser `{% csrf_token %}` dans les formulaires :
  ```html
  <form method="post">
    {% csrf_token %}
    ...
  </form>
  ```

- Utiliser `@csrf_exempt` uniquement en cas de n√©cessit√© absolue et documenter pourquoi
- Configurer `CSRF_TRUSTED_ORIGINS` en production :
  ```python
  CSRF_TRUSTED_ORIGINS = ['https://votredomaine.com']
  ```

### Protection XSS
- **JAMAIS** utiliser `|safe` sans validation stricte :
  ```html
  <!-- ‚ùå MAUVAIS -->
  {{ user_input|safe }}
  
  <!-- ‚úÖ BON -->
  {{ user_input|escape }}
  <!-- ou simplement -->
  {{ user_input }}
  ```

- Utiliser `mark_safe()` uniquement pour du contenu de confiance valid√©
- √âchapper automatiquement dans les templates Django (comportement par d√©faut)

### Protection injection SQL
- **JAMAIS** utiliser des requ√™tes SQL brutes avec des donn√©es utilisateur :
  ```python
  # ‚ùå MAUVAIS
  query = f"SELECT * FROM products WHERE name = '{user_input}'"
  
  # ‚úÖ BON - utiliser l'ORM Django
  Product.objects.filter(name=user_input)
  ```

- Si requ√™te SQL brute n√©cessaire, utiliser les param√®tres :
  ```python
  # ‚úÖ BON
  from django.db import connection
  with connection.cursor() as cursor:
      cursor.execute("SELECT * FROM products WHERE name = %s", [user_input])
  ```

### Rate limiting
- Impl√©menter le rate limiting pour les endpoints sensibles :
  ```python
  from django.core.cache import cache
  from django.http import HttpResponseTooManyRequests
  
  def rate_limit_view(request):
      key = f'rate_limit_{request.META.get("REMOTE_ADDR")}'
      count = cache.get(key, 0)
      if count >= 10:
          return HttpResponseTooManyRequests()
      cache.set(key, count + 1, 60)  # 60 secondes
      # ... traitement normal
  ```

- Utiliser `django-ratelimit` si disponible sur o2switch

### Content Security Policy (CSP)
- Configurer CSP dans les settings :
  ```python
  SECURE_CONTENT_SECURITY_POLICY = {
      'default-src': "'self'",
      'script-src': "'self' 'unsafe-inline' https://cdn.jsdelivr.net",
      'style-src': "'self' 'unsafe-inline' https://cdn.jsdelivr.net",
      'img-src': "'self' data: https:",
  }
  ```

### Validation stricte des entr√©es
- **TOUJOURS** valider les donn√©es dans les forms Django :
  ```python
  class ProductForm(forms.ModelForm):
      def clean_price(self):
          price = self.cleaned_data['price']
          if price < 0:
              raise forms.ValidationError("Le prix doit √™tre positif")
          return price
  ```

- Utiliser les validators Django :
  ```python
  from django.core.validators import MinValueValidator, MaxValueValidator
  
  price = models.DecimalField(
      max_digits=10,
      decimal_places=2,
      validators=[MinValueValidator(0)]
  )
  ```

### Gestion s√©curis√©e des secrets
- **JAMAIS** commiter les secrets dans le code :
  ```python
  # ‚ùå MAUVAIS
  SECRET_KEY = "django-insecure-g4!ch..."
  
  # ‚úÖ BON
  import os
  SECRET_KEY = os.environ.get('SECRET_KEY')
  ```

- Utiliser `.env` pour le d√©veloppement local
- Utiliser les variables d'environnement du serveur en production
- Ajouter `.env` au `.gitignore`

### Autres mesures de s√©curit√©
- Configurer `SECURE_SSL_REDIRECT = True` en production
- Configurer `SESSION_COOKIE_SECURE = True` en production
- Configurer `CSRF_COOKIE_SECURE = True` en production
- Utiliser `SECURE_BROWSER_XSS_FILTER = True`
- Configurer `X_FRAME_OPTIONS = 'DENY'` pour √©viter le clickjacking
- Limiter la taille des uploads :
  ```python
  FILE_UPLOAD_MAX_MEMORY_SIZE = 2621440  # 2.5 MB
  DATA_UPLOAD_MAX_MEMORY_SIZE = 2621440
  ```

---

## 7. Qualit√© de code

### PEP 8
- Respecter PEP 8 pour le style Python
- Longueur de ligne : 88 caract√®res (Black) ou 79 caract√®res (PEP 8 standard)
- Utiliser 4 espaces pour l'indentation (jamais de tabs)
- Nommer les variables en snake_case, les classes en PascalCase

### Flake8
- Utiliser Flake8 pour le linting
- Configurer `.flake8` ou `setup.cfg` :
  ```ini
  [flake8]
  max-line-length = 88
  exclude = migrations,venv,env
  ignore = E203, W503
  ```

- Ex√©cuter Flake8 avant chaque commit :
  ```bash
  flake8 .
  ```

### Docstrings
- **TOUJOURS** documenter les fonctions et classes avec des docstrings :
  ```python
  def calculate_total_price(products):
      """
      Calcule le prix total d'une liste de produits.
      
      Args:
          products: QuerySet ou liste d'objets Product
      
      Returns:
          Decimal: Le prix total
      """
      return sum(product.price for product in products)
  ```

- Utiliser le format Google ou NumPy pour les docstrings

### Type hints
- Ajouter des type hints pour les fonctions complexes :
  ```python
  from typing import List, Optional
  from decimal import Decimal
  
  def calculate_total_price(products: List[Product]) -> Decimal:
      ...
  ```

- Utiliser `Optional` pour les valeurs qui peuvent √™tre None :
  ```python
  def get_product(slug: str) -> Optional[Product]:
      ...
  ```

### Structure du code
- Garder les fonctions courtes et focalis√©es (max 50 lignes id√©alement)
- √âviter la duplication de code (DRY - Don't Repeat Yourself)
- Utiliser des constantes pour les valeurs magiques :
  ```python
  # ‚ùå MAUVAIS
  if status == 2:
      ...
  
  # ‚úÖ BON
  STATUS_PUBLISHED = 2
  if status == STATUS_PUBLISHED:
      ...
  ```

---

## 8. Tests

### Tests complets
- √âcrire des tests unitaires pour tous les mod√®les et fonctions utilitaires
- √âcrire des tests d'int√©gration pour les vues et les formulaires
- √âcrire des tests fonctionnels pour les parcours utilisateur complets

### Structure des tests
- Organiser les tests par app dans `tests.py` ou `tests/` :
  ```python
  from django.test import TestCase
  from .models import Product
  
  class ProductModelTest(TestCase):
      def setUp(self):
          self.product = Product.objects.create(
              name="Test Product",
              price=10.00
          )
      
      def test_product_str(self):
          self.assertEqual(str(self.product), "Test Product")
  ```

### Tests de vues
- Utiliser `Client` pour tester les vues :
  ```python
  from django.test import TestCase, Client
  
  class ProductViewTest(TestCase):
      def setUp(self):
          self.client = Client()
      
      def test_product_list_view(self):
          response = self.client.get('/products/')
          self.assertEqual(response.status_code, 200)
  ```

### Tests de formulaires
- Tester la validation des formulaires :
  ```python
  from django.test import TestCase
  from .forms import ProductForm
  
  class ProductFormTest(TestCase):
      def test_valid_form(self):
          form_data = {'name': 'Test', 'price': 10.00}
          form = ProductForm(data=form_data)
          self.assertTrue(form.is_valid())
      
      def test_invalid_price(self):
          form_data = {'name': 'Test', 'price': -10}
          form = ProductForm(data=form_data)
          self.assertFalse(form.is_valid())
  ```

### Coverage
- Viser un taux de couverture de code √©lev√© (80%+)
- Utiliser `coverage.py` pour mesurer la couverture :
  ```bash
  coverage run --source='.' manage.py test
  coverage report
  ```

---

## 9. Configuration sp√©cifique o2switch (h√©bergement mutualis√©)

### Contraintes
- Pas de serveur d√©di√© : √©viter les technologies n√©cessitant un acc√®s root
- Pas de Redis/Memcached par d√©faut : utiliser le cache en base de donn√©es
- Configuration PostgreSQL standard
- Gestion des fichiers statiques avec WhiteNoise

### Cache en base de donn√©es
- Configurer le cache Django en base de donn√©es :
  ```python
  CACHES = {
      'default': {
          'BACKEND': 'django.core.cache.backends.db.DatabaseCache',
          'LOCATION': 'cache_table',
      }
  }
  ```

- Cr√©er la table de cache :
  ```bash
  python manage.py createcachetable
  ```

### WhiteNoise pour fichiers statiques
- Installer WhiteNoise : `pip install whitenoise`
- Configurer dans `settings.py` (voir section Performance HTML/Frontend)
- S'assurer que `STATIC_ROOT` est d√©fini :
  ```python
  STATIC_ROOT = BASE_DIR / 'staticfiles'
  ```

### Variables d'environnement
- Utiliser les variables d'environnement fournies par o2switch
- Configurer `ALLOWED_HOSTS` dynamiquement :
  ```python
  ALLOWED_HOSTS = os.environ.get('ALLOWED_HOSTS', '').split(',')
  ```

### Base de donn√©es PostgreSQL
- Configurer la connexion PostgreSQL :
  ```python
  DATABASES = {
      'default': {
          'ENGINE': 'django.db.backends.postgresql',
          'NAME': os.environ.get('DB_NAME'),
          'USER': os.environ.get('DB_USER'),
          'PASSWORD': os.environ.get('DB_PASSWORD'),
          'HOST': os.environ.get('DB_HOST', 'localhost'),
          'PORT': os.environ.get('DB_PORT', '5432'),
      }
  }
  ```

### Pas de d√©pendances serveur d√©di√©
- √âviter les packages n√©cessitant des compilations natives complexes
- V√©rifier la compatibilit√© des packages avec l'environnement Python d'o2switch
- Utiliser des alternatives compatibles h√©bergement mutualis√©

---

## 10. Vue.js

### Int√©gration
- Charger Vue.js avec `defer` :
  ```html
  <script src="https://unpkg.com/vue@3/dist/vue.global.js" defer></script>
  ```

### Bonnes pratiques Vue.js
- Utiliser la Composition API pour les composants complexes
- √âviter les mutations directes des props
- Utiliser `v-bind` ou `:` pour les attributs dynamiques
- Utiliser `v-on` ou `@` pour les √©v√©nements
- G√©rer le state de mani√®re pr√©visible

### Accessibilit√© avec Vue.js
- S'assurer que les composants Vue sont accessibles au clavier
- Utiliser les attributs ARIA dans les templates Vue
- G√©rer le focus dans les composants interactifs

### Performance Vue.js
- Utiliser `v-once` pour les √©l√©ments statiques
- Utiliser `v-memo` pour optimiser les listes
- √âviter les watchers co√ªteux

---

## 11. Mode sombre

### Impl√©mentation
- Utiliser `prefers-color-scheme` pour d√©tecter la pr√©f√©rence syst√®me :
  ```css
  @media (prefers-color-scheme: dark) {
    /* Styles dark mode */
  }
  ```

- Ou utiliser une classe toggle avec Tailwind :
  ```html
  <html class="dark">
  ```

- Configurer Tailwind pour le mode sombre :
  ```javascript
  // Dans la config Tailwind si n√©cessaire
  darkMode: 'class',
  ```

### Bonnes pratiques mode sombre
- Tester le contraste dans les deux modes (WCAG AAA)
- Fournir un toggle pour permettre √† l'utilisateur de choisir
- Sauvegarder la pr√©f√©rence utilisateur (localStorage ou cookie)

---

## 12. Authentification

### Syst√®me d'authentification complet
- Utiliser `django.contrib.auth` pour l'authentification de base
- Cr√©er des vues personnalis√©es si n√©cessaire :
  ```python
  from django.contrib.auth.views import LoginView, LogoutView
  from django.contrib.auth.forms import AuthenticationForm
  
  class CustomLoginView(LoginView):
      template_name = 'accounts/login.html'
      form_class = AuthenticationForm
  ```

### S√©curit√© des mots de passe
- Utiliser les validators Django par d√©faut
- Ne jamais stocker les mots de passe en clair
- Utiliser `make_password()` et `check_password()` si n√©cessaire

### Sessions
- Configurer les sessions de mani√®re s√©curis√©e :
  ```python
  SESSION_COOKIE_SECURE = True  # En production
  SESSION_COOKIE_HTTPONLY = True
  SESSION_COOKIE_SAMESITE = 'Lax'
  ```

---

## 13. Admin Django personnalis√©

### Personnalisation compl√®te
- Cr√©er des classes Admin personnalis√©es :
  ```python
  from django.contrib import admin
  from .models import Product
  
  @admin.register(Product)
  class ProductAdmin(admin.ModelAdmin):
      list_display = ['name', 'price', 'category', 'created_at']
      list_filter = ['category', 'status']
      search_fields = ['name', 'description']
      readonly_fields = ['created_at', 'updated_at']
  ```

### Am√©lioration de l'UX admin
- Utiliser `list_editable` pour l'√©dition rapide
- Utiliser `autocomplete_fields` pour les ForeignKey
- Cr√©er des actions personnalis√©es :
  ```python
  @admin.action(description='Marquer comme publi√©')
  def make_published(modeladmin, request, queryset):
      queryset.update(status='published')
  ```

---

## 14. Logging

### Configuration standard
- Configurer le logging dans `settings.py` :
  ```python
  LOGGING = {
      'version': 1,
      'disable_existing_loggers': False,
      'handlers': {
          'file': {
              'level': 'INFO',
              'class': 'logging.FileHandler',
              'filename': BASE_DIR / 'logs' / 'django.log',
          },
      },
      'loggers': {
          'django': {
              'handlers': ['file'],
              'level': 'INFO',
              'propagate': True,
            },
      },
  }
  ```

### Utilisation du logging
- Utiliser le logging au lieu de `print()` :
  ```python
  import logging
  logger = logging.getLogger(__name__)
  
  logger.info('Product created: %s', product.name)
  logger.error('Error processing order: %s', error)
  ```

---

## 15. CI/CD GitHub Actions

### Configuration GitHub Actions
- Cr√©er `.github/workflows/ci.yml` :
  ```yaml
  name: CI
  
  on: [push, pull_request]
  
  jobs:
    test:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2
        - name: Set up Python
          uses: actions/setup-python@v2
          with:
            python-version: '3.10'
        - name: Install dependencies
          run: |
            pip install -r requirements.txt
        - name: Run tests
          run: |
            python manage.py test
        - name: Run Flake8
          run: |
            pip install flake8
            flake8 .
  ```

---

## 16. R√®gles g√©n√©rales

### Commits
- Messages de commit clairs et descriptifs
- Utiliser le format conventionnel si possible : `type: description`

### Documentation
- Maintenir un README.md √† jour
- Documenter les APIs et les fonctions complexes
- Ajouter des commentaires pour expliquer le "pourquoi", pas le "quoi"

### Performance
- Toujours mesurer avant d'optimiser
- Utiliser Django Debug Toolbar en d√©veloppement pour identifier les probl√®mes
- Profiler les requ√™tes avec `connection.queries` en d√©veloppement

### Maintenance
- Mettre √† jour les d√©pendances r√©guli√®rement
- Suivre les security advisories de Django
- Maintenir le code propre et refactoriser quand n√©cessaire

---

## 17. Migrations Django

### R√®gles fondamentales
- **JAMAIS** modifier une migration d√©j√† d√©ploy√©e en production :
  ```python
  # ‚ùå MAUVAIS - Ne jamais faire √ßa
  # Modifier une migration existante apr√®s d√©ploiement
  
  # ‚úÖ BON - Cr√©er une nouvelle migration
  python manage.py makemigrations
  ```

- Toujours cr√©er des migrations pour chaque changement de mod√®le :
  ```bash
  python manage.py makemigrations
  python manage.py migrate
  ```

- V√©rifier les migrations avant de les appliquer :
  ```bash
  python manage.py makemigrations --dry-run
  python manage.py migrate --plan
  ```

### Migrations de donn√©es
- S√©parer les migrations de sch√©ma et les migrations de donn√©es :
  ```python
  # Migration de sch√©ma (auto-g√©n√©r√©e)
  # 0001_initial.py
  
  # Migration de donn√©es (manuelle)
  # 0002_populate_categories.py
  from django.db import migrations
  
  def populate_categories(apps, schema_editor):
      Category = apps.get_model('products', 'Category')
      Category.objects.create(name='√âlectronique')
      Category.objects.create(name='V√™tements')
  
  class Migration(migrations.Migration):
      dependencies = [
          ('products', '0001_initial'),
      ]
      operations = [
          migrations.RunPython(populate_categories),
      ]
  ```

### RunPython et RunSQL
- Utiliser `RunPython` avec pr√©caution, toujours r√©versible :
  ```python
  def forward(apps, schema_editor):
      # Migration forward
      pass
  
  def backward(apps, schema_editor):
      # Migration backward (rollback)
      pass
  
  operations = [
      migrations.RunPython(forward, backward),
  ]
  ```

- Utiliser `RunSQL` uniquement si n√©cessaire, avec `reverse_sql` :
  ```python
  operations = [
      migrations.RunSQL(
          "UPDATE products SET status = 'active' WHERE status IS NULL",
          reverse_sql="UPDATE products SET status = NULL WHERE status = 'active'"
      ),
  ]
  ```

### Tests des migrations
- Tester les migrations dans les tests :
  ```python
  from django.test import TestCase
  from django.db import connection
  
  class MigrationTest(TestCase):
      def test_migration_applies(self):
          # Appliquer la migration
          from django.core.management import call_command
          call_command('migrate', 'products', '0002')
          
          # V√©rifier le r√©sultat
          with connection.cursor() as cursor:
              cursor.execute("SELECT COUNT(*) FROM products_category")
              count = cursor.fetchone()[0]
              self.assertGreater(count, 0)
  ```

### Bonnes pratiques migrations
- Nommer les migrations de mani√®re descriptive :
  ```python
  # ‚úÖ BON
  # 0002_add_status_field_to_product.py
  # 0003_populate_initial_categories.py
  
  # ‚ùå MAUVAIS
  # 0002_auto_20240101_1234.py
  ```

- √âviter les migrations complexes, les diviser si n√©cessaire
- Documenter les migrations complexes avec des commentaires
- Tester les migrations sur une copie de la base de production avant d√©ploiement

---

## 18. Gestion des fichiers m√©dias

### Configuration MEDIA_ROOT et MEDIA_URL
- Configurer dans `settings.py` :
  ```python
  import os
  
  MEDIA_ROOT = BASE_DIR / 'media'
  MEDIA_URL = '/media/'
  ```

- Servir les m√©dias en d√©veloppement :
  ```python
  # urls.py
  from django.conf import settings
  from django.conf.urls.static import static
  
  if settings.DEBUG:
      urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
  ```

### Validation des types de fichiers
- Cr√©er un validator personnalis√© :
  ```python
  from django.core.exceptions import ValidationError
  import os
  
  def validate_file_extension(value):
      ext = os.path.splitext(value.name)[1]
      valid_extensions = ['.jpg', '.jpeg', '.png', '.gif', '.pdf', '.doc', '.docx']
      if not ext.lower() in valid_extensions:
          raise ValidationError('Type de fichier non autoris√©.')
  
  class Document(models.Model):
      file = models.FileField(upload_to='documents/', validators=[validate_file_extension])
  ```

- Utiliser `python-magic` pour v√©rifier le type r√©el du fichier :
  ```python
  import magic
  
  def validate_file_type(file):
      file_type = magic.from_buffer(file.read(1024), mime=True)
      allowed_types = ['image/jpeg', 'image/png', 'application/pdf']
      if file_type not in allowed_types:
          raise ValidationError('Type de fichier non autoris√©.')
      file.seek(0)  # R√©initialiser le pointeur
  ```

### Limitation de la taille des fichiers
- Configurer dans les settings :
  ```python
  FILE_UPLOAD_MAX_MEMORY_SIZE = 2621440  # 2.5 MB
  DATA_UPLOAD_MAX_MEMORY_SIZE = 2621440
  ```

- Valider dans le formulaire :
  ```python
  from django import forms
  
  class DocumentForm(forms.ModelForm):
      def clean_file(self):
          file = self.cleaned_data.get('file')
          if file:
              if file.size > 2.5 * 1024 * 1024:  # 2.5 MB
                  raise forms.ValidationError("Le fichier est trop volumineux (max 2.5 MB)")
          return file
  ```

### S√©curisation des uploads
- Renommer les fichiers upload√©s pour √©viter les collisions :
  ```python
  import uuid
  import os
  
  def upload_to(instance, filename):
      ext = filename.split('.')[-1]
      filename = f"{uuid.uuid4()}.{ext}"
      return os.path.join('uploads', filename)
  
  class Document(models.Model):
      file = models.FileField(upload_to=upload_to)
  ```

- Ne jamais ex√©cuter les fichiers upload√©s
- Scanner les fichiers pour les virus si possible
- Valider le contenu, pas seulement l'extension

### Organisation des fichiers m√©dias
- Organiser par type et date :
  ```python
  def upload_to(instance, filename):
      return f"{instance._meta.app_label}/{instance.__class__.__name__.lower()}/{timezone.now().year}/{timezone.now().month}/{filename}"
  ```

- Utiliser des dossiers s√©par√©s pour chaque type de m√©dia
- Nettoyer les fichiers orphelins r√©guli√®rement

### Gestion en production (o2switch)
- Les fichiers m√©dias doivent √™tre servis par le serveur web, pas par Django
- Configurer le serveur web pour servir `/media/`
- Utiliser un stockage cloud si n√©cessaire (AWS S3, etc.)
- Faire des sauvegardes r√©guli√®res des fichiers m√©dias

---

## 19. Permissions et autorisations

### Permissions Django par d√©faut
- Django cr√©e automatiquement 4 permissions par mod√®le : `add`, `change`, `delete`, `view`
- V√©rifier les permissions dans les vues :
  ```python
  from django.contrib.auth.decorators import permission_required
  
  @permission_required('products.add_product', raise_exception=True)
  def create_product(request):
      ...
  ```

### Permissions personnalis√©es
- D√©finir dans `Meta` du mod√®le :
  ```python
  class Product(models.Model):
      name = models.CharField(max_length=200)
      
      class Meta:
          permissions = [
              ('can_publish', 'Peut publier des produits'),
              ('can_feature', 'Peut mettre en avant'),
          ]
  ```

- Cr√©er les permissions dans une migration :
  ```python
  from django.db import migrations
  
  def create_permissions(apps, schema_editor):
      Permission = apps.get_model('auth', 'Permission')
      ContentType = apps.get_model('contenttypes', 'ContentType')
      Product = apps.get_model('products', 'Product')
      
      content_type = ContentType.objects.get_for_model(Product)
      Permission.objects.create(
          codename='can_publish',
          name='Peut publier des produits',
          content_type=content_type,
      )
  
  class Migration(migrations.Migration):
      operations = [
          migrations.RunPython(create_permissions),
      ]
  ```

### D√©corateurs et mixins
- Utiliser `@login_required` pour les vues n√©cessitant une authentification :
  ```python
  from django.contrib.auth.decorators import login_required
  
  @login_required
  def my_profile(request):
      ...
  ```

- Utiliser `@permission_required` pour les permissions sp√©cifiques :
  ```python
  from django.contrib.auth.decorators import permission_required
  
  @permission_required('products.add_product', raise_exception=True)
  def create_product(request):
      ...
  ```

- Utiliser des mixins pour les class-based views :
  ```python
  from django.contrib.auth.mixins import LoginRequiredMixin, PermissionRequiredMixin
  
  class ProductCreateView(LoginRequiredMixin, PermissionRequiredMixin, CreateView):
      permission_required = 'products.add_product'
      model = Product
      fields = ['name', 'price']
  ```

### Tests des permissions
- Tester les permissions dans les tests :
  ```python
  from django.contrib.auth.models import Permission
  from django.contrib.contenttypes.models import ContentType
  
  class ProductPermissionTest(TestCase):
      def setUp(self):
          self.user = User.objects.create_user('testuser')
          content_type = ContentType.objects.get_for_model(Product)
          permission = Permission.objects.get(
              codename='add_product',
              content_type=content_type,
          )
          self.user.user_permissions.add(permission)
      
      def test_user_can_create_product(self):
          self.client.force_login(self.user)
          response = self.client.post('/products/create/', {'name': 'Test'})
          self.assertEqual(response.status_code, 200)
  ```

---

## 20. Transactions de base de donn√©es

### Utilisation de @transaction.atomic
- Utiliser `@transaction.atomic` pour garantir l'int√©grit√© :
  ```python
  from django.db import transaction
  
  @transaction.atomic
  def transfer_money(from_account, to_account, amount):
      from_account.balance -= amount
      from_account.save()
      to_account.balance += amount
      to_account.save()
  ```

- Utiliser comme context manager :
  ```python
  def transfer_money(from_account, to_account, amount):
      with transaction.atomic():
          from_account.balance -= amount
          from_account.save()
          to_account.balance += amount
          to_account.save()
  ```

### Transactions dans les vues
- Les vues Django sont automatiquement dans une transaction
- Utiliser `@transaction.non_atomic_requests` pour d√©sactiver :
  ```python
  from django.db import transaction
  
  @transaction.non_atomic_requests
  def long_running_view(request):
      # Cette vue n'est pas dans une transaction
      ...
  ```

### Rollback automatique
- Les exceptions provoquent un rollback automatique :
  ```python
  @transaction.atomic
  def process_order(order):
      try:
          order.status = 'processing'
          order.save()
          charge_customer(order)
          order.status = 'completed'
          order.save()
      except PaymentError:
          # Rollback automatique, order.status reste inchang√©
          raise
  ```

### Transactions imbriqu√©es
- Les transactions imbriqu√©es utilisent des savepoints :
  ```python
  @transaction.atomic
  def outer_function():
      # Transaction principale
      inner_function()  # Cr√©e un savepoint
  
  @transaction.atomic
  def inner_function():
      # Savepoint cr√©√© automatiquement
      ...
  ```

### Optimistic locking
- Utiliser `select_for_update()` pour le locking pessimiste :
  ```python
  from django.db import transaction
  
  @transaction.atomic
  def update_balance(account_id, amount):
      account = Account.objects.select_for_update().get(pk=account_id)
      account.balance += amount
      account.save()
  ```

- Utiliser un champ `version` pour l'optimistic locking :
  ```python
  class Account(models.Model):
      balance = models.DecimalField(max_digits=10, decimal_places=2)
      version = models.IntegerField(default=0)
      
      def save(self, *args, **kwargs):
          self.version += 1
          super().save(*args, **kwargs)
  ```

---

## 21. Templates Django avanc√©s

### Filtres personnalis√©s
- Cr√©er des filtres dans `templatetags/` :
  ```python
  # myapp/templatetags/custom_filters.py
  from django import template
  
  register = template.Library()
  
  @register.filter(name='currency')
  def currency(value):
      return f"{value:.2f} ‚Ç¨"
  
  # Usage dans template
  # {{ product.price|currency }}
  ```

- Filtres avec arguments :
  ```python
  @register.filter
  def multiply(value, arg):
      return float(value) * float(arg)
  
  # Usage: {{ price|multiply:1.2 }}
  ```

### Tags personnalis√©s
- Cr√©er des tags simples :
  ```python
  @register.simple_tag
  def current_time(format_string):
      return datetime.datetime.now().strftime(format_string)
  
  # Usage: {% current_time "%Y-%m-%d" %}
  ```

- Cr√©er des inclusion tags :
  ```python
  @register.inclusion_tag('products/product_card.html')
  def product_card(product):
      return {'product': product}
  
  # Usage: {% product_card product %}
  ```

### Performance des templates
- √âviter les requ√™tes dans les templates :
  ```django
  {# ‚ùå MAUVAIS - N+1 queries #}
  {% for product in products %}
      {{ product.category.name }}
  {% endfor %}
  
  {# ‚úÖ BON - Pr√©charger dans la vue #}
  products = Product.objects.select_related('category').all()
  ```

- Utiliser `{% cache %}` pour les parties statiques :
  ```django
  {% load cache %}
  {% cache 3600 product_list %}
      {% for product in products %}
          ...
      {% endfor %}
  {% endcache %}
  ```

### Tests des templates
- Tester les templates dans les tests :
  ```python
  from django.test import TestCase
  from django.template import Template, Context
  
  class TemplateTest(TestCase):
      def test_currency_filter(self):
          template = Template('{{ price|currency }}')
          context = Context({'price': 10.50})
          result = template.render(context)
          self.assertIn('10.50', result)
  ```

---

## 22. Signaux Django

### Quand utiliser les signaux
- Utiliser les signaux pour la d√©coupe entre apps
- √âviter les signaux pour la logique m√©tier principale (utiliser les mod√®les ou services)
- Utiliser les signaux pour les actions transversales (logging, notifications, etc.)

### Bonnes pratiques
- Toujours documenter les signaux :
  ```python
  from django.db.models.signals import post_save
  from django.dispatch import receiver
  from .models import Order
  
  @receiver(post_save, sender=Order)
  def send_order_confirmation(sender, instance, created, **kwargs):
      """
      Envoie un email de confirmation apr√®s la cr√©ation d'une commande.
      """
      if created:
          send_confirmation_email(instance)
  ```

- Utiliser `dispatch_uid` pour √©viter les doublons :
  ```python
  @receiver(post_save, sender=Order, dispatch_uid="send_order_confirmation")
  def send_order_confirmation(sender, instance, created, **kwargs):
      ...
  ```

### √âviter les signaux dans les tests
- D√©sactiver les signaux dans les tests si n√©cessaire :
  ```python
  from django.test import TestCase
  from django.db.models.signals import post_save
  
  class OrderTest(TestCase):
      def setUp(self):
          post_save.disconnect(sender=Order)
      
      def tearDown(self):
          post_save.connect(sender=Order)
  ```

- Ou utiliser `@override_settings` pour remplacer temporairement

---

## 23. Gestion des erreurs et exceptions

### Pages d'erreur personnalis√©es
- Cr√©er `404.html`, `500.html`, `403.html`, `400.html` dans `templates/` :
  ```html
  <!-- templates/404.html -->
  <!DOCTYPE html>
  <html>
  <head>
      <title>Page non trouv√©e</title>
  </head>
  <body>
      <h1>404 - Page non trouv√©e</h1>
      <p>D√©sol√©, la page que vous cherchez n'existe pas.</p>
  </body>
  </html>
  ```

### Gestion centralis√©e des erreurs
- Cr√©er une vue pour g√©rer les erreurs :
  ```python
  # views.py
  from django.shortcuts import render
  
  def handler404(request, exception):
      return render(request, '404.html', status=404)
  
  def handler500(request):
      return render(request, '500.html', status=500)
  ```

- Configurer dans `urls.py` :
  ```python
  handler404 = 'myapp.views.handler404'
  handler500 = 'myapp.views.handler500'
  ```

### Logging des erreurs
- Logger les erreurs dans les vues :
  ```python
  import logging
  logger = logging.getLogger(__name__)
  
  def my_view(request):
      try:
          # Code qui peut √©chouer
          process_data()
      except Exception as e:
          logger.error('Erreur dans my_view: %s', e, exc_info=True)
          return render(request, 'error.html', {'error': str(e)})
  ```

### Messages d'erreur utilisateur-friendly
- Ne jamais exposer les d√©tails techniques aux utilisateurs :
  ```python
  # ‚ùå MAUVAIS
  except Exception as e:
      return HttpResponse(f"Erreur: {e}")
  
  # ‚úÖ BON
  except Exception as e:
      logger.error('Erreur technique: %s', e, exc_info=True)
      return render(request, 'error.html', {
          'message': 'Une erreur est survenue. Veuillez r√©essayer plus tard.'
      })
  ```

### Gestion des exceptions dans les vues
- Utiliser `try/except` pour les erreurs attendues :
  ```python
  from django.http import Http404
  
  def product_detail(request, pk):
      try:
          product = Product.objects.get(pk=pk)
      except Product.DoesNotExist:
          raise Http404("Produit non trouv√©")
      return render(request, 'product_detail.html', {'product': product})
  ```

---

## 24. Pagination

### Utilisation de Paginator
- Utiliser `Paginator` dans les vues :
  ```python
  from django.core.paginator import Paginator
  from django.shortcuts import render
  
  def product_list(request):
      products = Product.objects.all()
      paginator = Paginator(products, 25)  # 25 produits par page
      page_number = request.GET.get('page')
      page_obj = paginator.get_page(page_number)
      return render(request, 'product_list.html', {'page_obj': page_obj})
  ```

### Pagination dans les class-based views
- Utiliser `ListView` avec pagination automatique :
  ```python
  from django.views.generic import ListView
  
  class ProductListView(ListView):
      model = Product
      paginate_by = 25
      template_name = 'product_list.html'
  ```

- Personnaliser la pagination :
  ```python
  class ProductListView(ListView):
      model = Product
      paginate_by = 25
      paginate_orphans = 5  # Nombre d'√©l√©ments sur la derni√®re page
  ```

### Template de pagination
- Afficher la pagination dans le template :
  ```django
  {% if page_obj.has_other_pages %}
      <nav aria-label="Pagination">
          {% if page_obj.has_previous %}
              <a href="?page={{ page_obj.previous_page_number }}">Pr√©c√©dent</a>
          {% endif %}
          
          <span>Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}</span>
          
          {% if page_obj.has_next %}
              <a href="?page={{ page_obj.next_page_number }}">Suivant</a>
          {% endif %}
      </nav>
  {% endif %}
  ```

### Pagination AJAX/Vue.js
- Cr√©er une API pour la pagination AJAX :
  ```python
  from django.http import JsonResponse
  
  def product_list_api(request):
      products = Product.objects.all()
      paginator = Paginator(products, 25)
      page_number = request.GET.get('page', 1)
      page_obj = paginator.get_page(page_number)
      
      data = {
          'products': [{'id': p.id, 'name': p.name} for p in page_obj],
          'has_next': page_obj.has_next(),
          'has_previous': page_obj.has_previous(),
          'current_page': page_obj.number,
          'total_pages': paginator.num_pages,
      }
      return JsonResponse(data)
  ```

---

## 25. Bulk operations et optimisations

### bulk_create()
- Utiliser `bulk_create()` pour cr√©er plusieurs objets :
  ```python
  # ‚ùå MAUVAIS - N insertions
  for name in product_names:
      Product.objects.create(name=name)
  
  # ‚úÖ BON - 1 insertion
  products = [Product(name=name) for name in product_names]
  Product.objects.bulk_create(products)
  ```

- Limiter le nombre d'objets par batch :
  ```python
  def bulk_create_in_batches(objs, batch_size=1000):
      for i in range(0, len(objs), batch_size):
          Product.objects.bulk_create(objs[i:i+batch_size])
  ```

### bulk_update()
- Utiliser `bulk_update()` pour mettre √† jour plusieurs objets :
  ```python
  products = Product.objects.filter(category=old_category)
  for product in products:
      product.category = new_category
  Product.objects.bulk_update(products, ['category'])
  ```

### update() sur QuerySet
- Utiliser `update()` pour les mises √† jour simples :
  ```python
  # ‚ùå MAUVAIS - N updates
  for product in Product.objects.filter(status='draft'):
      product.status = 'published'
      product.save()
  
  # ‚úÖ BON - 1 update
  Product.objects.filter(status='draft').update(status='published')
  ```

### √âviter les boucles pour les updates
- Toujours pr√©f√©rer les op√©rations en masse :
  ```python
  # ‚ùå MAUVAIS
  for product in products:
      product.price *= 1.1
      product.save()
  
  # ‚úÖ BON
  from django.db.models import F
  Product.objects.filter(id__in=[p.id for p in products]).update(price=F('price') * 1.1)
  ```

---

## 26. Middleware personnalis√©s

### Quand cr√©er un middleware
- Pour ajouter des fonctionnalit√©s transversales (logging, timing, etc.)
- Pour modifier les requ√™tes/r√©ponses de mani√®re globale
- Pour g√©rer l'authentification personnalis√©e

### Structure d'un middleware
- Cr√©er un middleware :
  ```python
  class TimingMiddleware:
      def __init__(self, get_response):
          self.get_response = get_response
      
      def __call__(self, request):
          start_time = time.time()
          response = self.get_response(request)
          duration = time.time() - start_time
          response['X-Process-Time'] = str(duration)
          return response
  ```

- Middleware avec `process_request` et `process_response` :
  ```python
  class CustomHeaderMiddleware:
      def __init__(self, get_response):
          self.get_response = get_response
      
      def process_request(self, request):
          # Code ex√©cut√© avant la vue
          request.custom_data = 'value'
      
      def process_response(self, request, response):
          # Code ex√©cut√© apr√®s la vue
          response['X-Custom-Header'] = 'value'
          return response
  ```

### Ordre des middlewares
- L'ordre est important dans `MIDDLEWARE` :
  ```python
  MIDDLEWARE = [
      'django.middleware.security.SecurityMiddleware',  # Premier
      'whitenoise.middleware.WhiteNoiseMiddleware',
      'django.contrib.sessions.middleware.SessionMiddleware',
      'django.middleware.common.CommonMiddleware',
      'django.middleware.csrf.CsrfViewMiddleware',
      'django.contrib.auth.middleware.AuthenticationMiddleware',
      'myapp.middleware.CustomMiddleware',  # Apr√®s auth
      'django.contrib.messages.middleware.MessageMiddleware',
      'django.middleware.clickjacking.XFrameOptionsMiddleware',  # Dernier
  ]
  ```

### Tests des middlewares
- Tester les middlewares :
  ```python
  from django.test import RequestFactory
  from django.http import HttpResponse
  
  class MiddlewareTest(TestCase):
      def setUp(self):
          self.factory = RequestFactory()
      
      def test_timing_middleware(self):
          middleware = TimingMiddleware(lambda req: HttpResponse())
          request = self.factory.get('/')
          response = middleware(request)
          self.assertIn('X-Process-Time', response)
  ```

---

## 27. Performance et monitoring

### Django Debug Toolbar
- Installer en d√©veloppement uniquement :
  ```python
  # settings.py
  if DEBUG:
      INSTALLED_APPS += ['debug_toolbar']
      MIDDLEWARE += ['debug_toolbar.middleware.DebugToolbarMiddleware']
      INTERNAL_IPS = ['127.0.0.1']
  ```

- Configurer les URLs :
  ```python
  if settings.DEBUG:
      import debug_toolbar
      urlpatterns = [
          path('__debug__/', include(debug_toolbar.urls)),
      ] + urlpatterns
  ```

### Monitoring des requ√™tes lentes
- Logger les requ√™tes lentes :
  ```python
  # settings.py
  LOGGING = {
      'loggers': {
          'django.db.backends': {
              'level': 'DEBUG',
              'handlers': ['console'],
          },
      },
  }
  
  # Middleware pour logger les requ√™tes lentes
  import time
  import logging
  logger = logging.getLogger('django.db.backends')
  
  class SlowQueryMiddleware:
      def __init__(self, get_response):
          self.get_response = get_response
      
      def __call__(self, request):
          start_time = time.time()
          response = self.get_response(request)
          duration = time.time() - start_time
          if duration > 1.0:  # Plus d'1 seconde
              logger.warning(f'Requ√™te lente: {request.path} ({duration:.2f}s)')
          return response
  ```

### Optimisation des templates
- Utiliser `{% cache %}` efficacement :
  ```django
  {% load cache %}
  {% cache 3600 product_list request.user.id %}
      {% for product in products %}
          ...
      {% endfor %}
  {% endcache %}
  ```

- √âviter les requ√™tes dans les templates (voir section Templates Django avanc√©s)

---

## 28. S√©curit√© avanc√©e

### Protection contre les attaques par force brute
- Limiter les tentatives de connexion :
  ```python
  from django.core.cache import cache
  from django.http import HttpResponseTooManyRequests
  
  def rate_limit_login(request):
      ip = request.META.get('REMOTE_ADDR')
      key = f'login_attempts_{ip}'
      attempts = cache.get(key, 0)
      
      if attempts >= 5:
          return HttpResponseTooManyRequests()
      
      # Apr√®s √©chec de connexion
      cache.set(key, attempts + 1, 300)  # 5 minutes
  ```

### Validation des uploads de fichiers
- Valider le type MIME r√©el, pas seulement l'extension (voir section Gestion des fichiers m√©dias)
- Limiter la taille des fichiers
- Scanner les fichiers pour les virus si possible

### Sanitization des donn√©es utilisateur
- Toujours √©chapper dans les templates (comportement par d√©faut Django)
- Utiliser `bleach` pour nettoyer le HTML utilisateur :
  ```python
  import bleach
  
  cleaned_html = bleach.clean(
      user_input,
      tags=['p', 'br', 'strong', 'em'],
      attributes={},
      strip=True
  )
  ```

### Headers de s√©curit√© HTTP
- Configurer les headers de s√©curit√© :
  ```python
  SECURE_BROWSER_XSS_FILTER = True
  SECURE_CONTENT_TYPE_NOSNIFF = True
  X_FRAME_OPTIONS = 'DENY'
  SECURE_HSTS_SECONDS = 31536000
  SECURE_HSTS_INCLUDE_SUBDOMAINS = True
  SECURE_HSTS_PRELOAD = True
  ```

### Protection contre les attaques DoS
- Limiter la taille des requ√™tes :
  ```python
  DATA_UPLOAD_MAX_MEMORY_SIZE = 2621440  # 2.5 MB
  FILE_UPLOAD_MAX_MEMORY_SIZE = 2621440
  ```

- Utiliser le rate limiting (voir section S√©curit√©)
- Configurer le timeout des requ√™tes au niveau du serveur web

---

## 29. Sessions et √©tat

### Configuration des sessions
- Configurer dans `settings.py` :
  ```python
  SESSION_ENGINE = 'django.contrib.sessions.backends.db'  # Par d√©faut
  SESSION_COOKIE_AGE = 86400  # 24 heures
  SESSION_COOKIE_SECURE = True  # En production
  SESSION_COOKIE_HTTPONLY = True
  SESSION_COOKIE_SAMESITE = 'Lax'
  ```

### Session backend personnalis√©
- Utiliser le cache pour les sessions si disponible :
  ```python
  SESSION_ENGINE = 'django.contrib.sessions.backends.cache'
  SESSION_CACHE_ALIAS = 'default'
  ```

- Pour o2switch, utiliser le cache DB :
  ```python
  SESSION_ENGINE = 'django.contrib.sessions.backends.cached_db'
  ```

### Expiration des sessions
- Nettoyer les sessions expir√©es :
  ```bash
  python manage.py clearsessions
  ```

- Configurer un cron job pour nettoyer r√©guli√®rement

### S√©curit√© des sessions
- R√©g√©n√©rer la session apr√®s connexion :
  ```python
  from django.contrib.auth import login
  
  def custom_login(request, user):
      login(request, user)
      request.session.cycle_key()  # R√©g√©n√®re la cl√© de session
  ```

- Ne jamais stocker de donn√©es sensibles dans la session
- Utiliser des sessions s√©curis√©es en production (HTTPS)

---

## Rappels importants

1. **SQL** : Toujours utiliser `select_related()` et `prefetch_related()` pour √©viter N+1 queries
2. **Accessibilit√©** : WCAG AAA est l'objectif, tester avec des lecteurs d'√©cran
3. **S√©curit√©** : Ne jamais commiter les secrets, toujours valider les entr√©es
4. **Performance** : Lazy loading des images, d√©ferrer les scripts, utiliser WhiteNoise
5. **Code quality** : Flake8 avant chaque commit, tests complets, docstrings
6. **o2switch** : Pas de Redis/Memcached, utiliser cache DB, WhiteNoise pour statiques
7. **Responsive** : Mobile-first avec Tailwind, tester tous les breakpoints
8. **Accessibilit√©** : Contraste 7:1 pour texte normal, navigation clavier, ARIA appropri√©s

