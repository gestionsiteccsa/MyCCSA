{% extends "base.html" %}

{% block title %}Timeline des événements{% endblock %}
{% block description %}Consultez tous les événements dans la timeline chronologique{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header class="mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 border border-gray-100">
            <div class="flex flex-col md:flex-row items-center md:items-start justify-between gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2 flex items-center gap-3">
                        <svg class="w-8 h-8 text-custom-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Timeline des événements
                    </h1>
                    <p class="text-gray-600">Consultez tous les événements dans la timeline chronologique</p>
                </div>
                <div class="flex gap-3">
                    <a
                        href="{% url 'events:calendar' %}"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200 font-semibold shadow-sm hover:shadow-md"
                        aria-label="Retour au calendrier"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7l4-4m0 0l4 4m-4-4v18"></path>
                        </svg>
                        Calendrier
                    </a>
                    <a
                        href="{% url 'events:create' %}"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-custom-blue text-white rounded-lg hover:bg-custom-blue-hover focus:outline-none focus:ring-2 focus:ring-custom-blue focus:ring-offset-2 transition-all duration-200 font-semibold shadow-md hover:shadow-lg"
                        aria-label="Créer un nouvel événement"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Créer un événement
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Légende des statuts -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-gray-100">
        <div class="flex flex-wrap items-center gap-6 text-sm">
            <span class="font-semibold text-gray-700">Légende validation :</span>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded border-2 border-orange-400 bg-orange-50"></div>
                <span class="text-gray-600">En attente</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded border-2 border-green-500 bg-green-50"></div>
                <span class="text-gray-600">Validé</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded border-2 border-red-500 bg-red-50"></div>
                <span class="text-gray-600">Refusé</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded border-2 border-gray-200 bg-gray-50"></div>
                <span class="text-gray-600">Sans validation</span>
            </div>
        </div>
    </div>

    <!-- Timeline -->
    <div id="timeline-app">
        {% if timeline_months %}
            {% for month in timeline_months %}
            <!-- Section du mois -->
            <section class="bg-white shadow-md rounded-xl p-6 md:p-8 mb-6 border border-gray-100">
                <!-- En-tête du mois -->
                <button
                    @click="toggleMonth('{{ month.key }}')"
                    @keydown.enter="toggleMonth('{{ month.key }}')"
                    @keydown.space.prevent="toggleMonth('{{ month.key }}')"
                    :aria-expanded="visibleMonths['{{ month.key }}']"
                    aria-label="Afficher ou masquer les événements de {{ month.name }}"
                    class="w-full flex items-center justify-between mb-6 focus:outline-none focus:ring-2 focus:ring-custom-blue focus:ring-offset-2 rounded-lg p-2 -m-2 transition-colors duration-200 hover:bg-gray-50"
                >
                    <h2 class="text-xl md:text-2xl font-semibold text-gray-900 flex items-center gap-3">
                        <svg class="w-6 h-6 text-custom-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        {{ month.name }}
                    </h2>
                    <div class="flex items-center gap-3">
                        <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">
                            {{ month.count }} Entrée{{ month.count|pluralize }}
                        </span>
                        <svg 
                            class="w-5 h-5 text-gray-500 transition-transform duration-200"
                            :class="{ 'rotate-180': visibleMonths['{{ month.key }}'] }"
                            fill="none" 
                            stroke="currentColor" 
                            viewBox="0 0 24 24"
                            aria-hidden="true"
                        >
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </button>
                
                <!-- Section des dates (masquable) -->
                <div v-show="visibleMonths['{{ month.key }}']" class="space-y-8" {% if forloop.first %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                    {% for date_info in month.dates %}
                    <!-- Section de la date -->
                    <div class="relative pl-8 md:pl-12 border-l-2 border-gray-200">
                        <!-- Badge de la date -->
                        <div class="absolute -left-3 top-0 flex items-center gap-2 mb-4">
                            <div class="w-6 h-6 bg-custom-blue rounded-full border-4 border-white shadow-md flex-shrink-0"></div>
                            <div class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm font-semibold shadow-md">
                                {{ date_info.day }}, {{ date_info.day_name }}
                            </div>
                        </div>
                        
                        <!-- Grille d'événements -->
                        <div class="pt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {% for event_data in date_info.events %}
                            <!-- Carte d'événement -->
                            <div class="bg-white border-4 {{ event_data.event.couleur_statut_validation }} rounded-xl p-6 hover:border-custom-blue hover:shadow-lg transition-all duration-200 focus-within:ring-2 focus-within:ring-custom-blue focus-within:ring-offset-2 {% if event_data.is_past %}opacity-60{% endif %}">
                                <!-- Titre avec icône -->
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex items-start gap-3 flex-grow">
                                        <div class="flex-shrink-0 w-10 h-10 rounded-lg flex items-center justify-center" style="background-color: rgba(31, 77, 155, 0.1);">
                                            {% if event_data.is_creation %}
                                            <!-- Icône création -->
                                            <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                            </svg>
                                            {% else %}
                                            <!-- Icône édition -->
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow min-w-0">
                                            <div class="flex items-center gap-2 mb-1">
                                                <h3 class="text-lg font-semibold text-gray-900">{{ event_data.event.titre }}</h3>
                                                {% if event_data.is_past %}
                                                <span class="px-2 py-0.5 bg-gray-500 text-white text-xs font-medium rounded-full">
                                                    Fini
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <a
                                        href="{% url 'events:detail' event_data.event.pk %}"
                                        class="flex-shrink-0 text-sm text-custom-blue hover:text-custom-blue-hover font-medium focus:outline-none focus:ring-2 focus:ring-custom-blue rounded px-2 py-1 transition-colors"
                                        aria-label="Voir les détails de {{ event_data.event.titre }}"
                                    >
                                        Détails
                                    </a>
                                </div>
                                
                                <!-- Contenu -->
                                <dl class="space-y-3">
                                    {% if event_data.event.lieu or event_data.lieu_display %}
                                    <div class="flex items-start gap-3">
                                        <div class="flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: rgba(31, 77, 155, 0.1);">
                                            <svg class="w-4 h-4 text-custom-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-grow min-w-0">
                                            <dt class="text-xs font-medium text-gray-500 mb-0.5">Lieu</dt>
                                            <dd class="text-sm text-gray-900">{{ event_data.lieu_display|default:event_data.event.lieu }}</dd>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="flex items-start gap-3">
                                        <div class="flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: rgba(31, 77, 155, 0.1);">
                                            <svg class="w-4 h-4 text-custom-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-grow min-w-0">
                                            <dt class="text-xs font-medium text-gray-500 mb-0.5">Début</dt>
                                            <dd class="text-sm text-gray-900 font-medium">{{ event_data.date_formatted }} à {{ event_data.heure_debut }}</dd>
                                        </div>
                                    </div>
                                    
                                    {% if event_data.date_fin_formatted %}
                                    <div class="flex items-start gap-3">
                                        <div class="flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: rgba(31, 77, 155, 0.1);">
                                            <svg class="w-4 h-4 text-custom-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-grow min-w-0">
                                            <dt class="text-xs font-medium text-gray-500 mb-0.5">Fin</dt>
                                            <dd class="text-sm text-gray-900 font-medium">{{ event_data.date_fin_formatted }} à {{ event_data.heure_fin }}</dd>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if event_data.event.description %}
                                    <div class="flex items-start gap-3">
                                        <div class="flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: rgba(31, 77, 155, 0.1);">
                                            <svg class="w-4 h-4 text-custom-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-grow min-w-0">
                                            <dt class="text-xs font-medium text-gray-500 mb-0.5">Description</dt>
                                            <dd class="text-sm text-gray-900">{{ event_data.event.description|truncatewords:20 }}</dd>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if event_data.event.secteurs.all %}
                                    <div class="flex items-start gap-3">
                                        <div class="flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: rgba(31, 77, 155, 0.1);">
                                            <svg class="w-4 h-4 text-custom-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-grow min-w-0">
                                            <dt class="text-xs font-medium text-gray-500 mb-1">Secteurs</dt>
                                            <dd class="flex flex-wrap gap-2">
                                                {% for secteur in event_data.event.secteurs.all %}
                                                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg border border-gray-200 text-xs font-medium text-gray-700">
                                                    <span 
                                                        class="w-3 h-3 rounded border border-gray-300 flex-shrink-0"
                                                        style="background-color: {{ secteur.couleur }};"
                                                        aria-label="Couleur du secteur {{ secteur.nom }}"
                                                    ></span>
                                                    {{ secteur.nom }}
                                                </span>
                                                {% endfor %}
                                            </dd>
                                        </div>
                                    </div>
                                    {% endif %}
                                </dl>
                                
                                <!-- Footer avec créateur -->
                                <div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-end gap-2">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <span class="text-xs text-gray-600 italic">{{ event_data.createur_nom }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endfor %}
        {% else %}
        <!-- Message si aucun événement -->
        <section class="bg-white shadow-md rounded-xl p-6 md:p-8 border border-gray-100">
            <div class="text-center py-12">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-gray-600 text-lg mb-4">Aucun événement à afficher dans la timeline.</p>
                <a
                    href="{% url 'events:create' %}"
                    class="inline-flex items-center gap-2 px-6 py-3 bg-custom-blue text-white rounded-lg hover:bg-custom-blue-hover focus:outline-none focus:ring-2 focus:ring-custom-blue focus:ring-offset-2 transition-all duration-200 font-semibold shadow-md hover:shadow-lg"
                    aria-label="Créer un nouvel événement"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Créer un événement
                </a>
            </div>
        </section>
        {% endif %}
    </div>
</div>
{% endblock %}  

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier que Vue est disponible
    if (typeof Vue === 'undefined') {
        console.error('Vue.js n\'est pas chargé');
        // Afficher toutes les sections si Vue n'est pas disponible
        const sections = document.querySelectorAll('[v-show]');
        sections.forEach((section, index) => {
            if (index === 0) {
                section.style.display = 'block';
            }
        });
        return;
    }
    
    const { createApp } = Vue;
    
    createApp({
        data() {
            // Initialiser l'état de visibilité des mois depuis localStorage
            const savedState = localStorage.getItem('timeline_visible_months');
            const initialVisible = savedState ? JSON.parse(savedState) : {};
            
            // Si aucun état sauvegardé, ouvrir le premier mois par défaut
            const visibleMonths = {};
            {% if timeline_months %}
            {% for month in timeline_months %}
            visibleMonths['{{ month.key }}'] = initialVisible['{{ month.key }}'] !== undefined 
                ? initialVisible['{{ month.key }}'] 
                : {% if forloop.first %}true{% else %}false{% endif %};
            {% endfor %}
            {% endif %}
            
            return {
                visibleMonths: visibleMonths
            };
        },
        methods: {
            toggleMonth(monthKey) {
                this.visibleMonths[monthKey] = !this.visibleMonths[monthKey];
                // Sauvegarder l'état dans localStorage
                localStorage.setItem('timeline_visible_months', JSON.stringify(this.visibleMonths));
            }
        }
    }).mount('#timeline-app');
});
</script>
{% endblock %}
