{% extends "base.html" %}

{% block title %}Calendrier des événements{% endblock %}
{% block description %}Consultez tous les événements dans le calendrier{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header class="mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 border border-gray-100">
            <div class="flex flex-col md:flex-row items-center md:items-start justify-between gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
                        Calendrier des événements
                    </h1>
                    <p class="text-gray-600">Consultez tous les événements dans le calendrier</p>
                </div>
                <div class="flex flex-wrap gap-3">
                    <a
                        href="{% url 'events:timeline' %}"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200 font-semibold shadow-sm hover:shadow-md"
                        aria-label="Voir la timeline des événements"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Timeline
                    </a>
                    {% if can_view_stats %}
                    <a
                        href="{% url 'events:stats' %}"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-50 text-indigo-700 border border-indigo-100 rounded-lg hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-200 font-semibold shadow-sm hover:shadow-md"
                        aria-label="Voir les statistiques des événements"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Statistiques
                    </a>
                    {% endif %}
                    <a
                        href="{% url 'events:create' %}"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-custom-blue text-white rounded-lg hover:bg-custom-blue-hover focus:outline-none focus:ring-2 focus:ring-custom-blue focus:ring-offset-2 transition-all duration-200 font-semibold shadow-md hover:shadow-lg"
                        aria-label="Créer un nouvel événement"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Créer un événement
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Calendrier -->
    <section class="bg-white shadow-md rounded-xl p-6 md:p-8 border border-gray-100">
        <div id="calendar" class="w-full"></div>
    </section>
</div>

{% block extra_scripts %}
<!-- FullCalendar.js -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<!-- Tippy.js pour les tooltips -->
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>

<style>
    /* Styles pour les tooltips */
    .tippy-box[data-theme~='event-tooltip'] {
        background-color: white;
        color: #111827;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        padding: 0;
        max-width: 320px;
    }
    
    .tippy-box[data-theme~='event-tooltip'][data-placement^='top'] > .tippy-arrow::before {
        border-top-color: white;
    }
    
    .tippy-box[data-theme~='event-tooltip'][data-placement^='bottom'] > .tippy-arrow::before {
        border-bottom-color: white;
    }
    
    .tippy-box[data-theme~='event-tooltip'][data-placement^='left'] > .tippy-arrow::before {
        border-left-color: white;
    }
    
    .tippy-box[data-theme~='event-tooltip'][data-placement^='right'] > .tippy-arrow::before {
        border-right-color: white;
    }
    
    .event-tooltip-content {
        padding: 1rem;
    }
    
    .event-tooltip-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.75rem;
        line-height: 1.4;
    }
    
    .event-tooltip-info {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .event-tooltip-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #374151;
    }
    
    .event-tooltip-item svg {
        width: 1rem;
        height: 1rem;
        flex-shrink: 0;
        color: #6b7280;
    }
    
    .event-tooltip-item strong {
        color: #111827;
        font-weight: 600;
    }
    
    /* Support prefers-reduced-motion */
    @media (prefers-reduced-motion: reduce) {
        .tippy-box[data-theme~='event-tooltip'] {
            transition: none !important;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        
        // Préparer les événements pour FullCalendar
        const calendarEvents = [
            {% for event in events %}
            {
                id: {{ event.id }},
                title: '{{ event.titre|escapejs }}',
                start: '{{ event.date_debut|date:"Y-m-d\TH:i:s" }}',
                {% if event.date_fin %}
                end: '{{ event.date_fin|date:"Y-m-d\TH:i:s" }}',
                {% endif %}
                color: '{{ event.couleur_calendrier|default:"#808080" }}',
                url: '{% url "events:detail" event.pk %}',
                extendedProps: {
                    lieu: '{{ event.lieu|escapejs|default:"" }}',
                    secteurs: [
                        {% for secteur in event.secteurs.all %}
                        '{{ secteur.nom|escapejs }}',
                        {% endfor %}
                    ],
                    createur_nom: '{{ event.createur.get_full_name|default:event.createur.email|escapejs }}',
                    createur_email: '{{ event.createur.email|escapejs }}',
                    date_debut_formatted: '{{ event.date_debut|date:"d/m/Y" }}',
                    heure_debut_formatted: '{{ event.date_debut|date:"H:i" }}',
                    date_fin_formatted: '{{ event.date_fin|date:"d/m/Y"|default:"" }}',
                    heure_fin_formatted: '{{ event.date_fin|date:"H:i"|default:"" }}',
                }
            },
            {% endfor %}
        ];
        
        // Fonction pour créer le contenu HTML du tooltip
        function createTooltipContent(event) {
            const props = event.extendedProps;
            let html = '<div class="event-tooltip-content">';
            
            // Titre
            html += `<div class="event-tooltip-title">${event.title}</div>`;
            
            // Informations
            html += '<div class="event-tooltip-info">';
            
            // Date de début
            html += '<div class="event-tooltip-item">';
            html += '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">';
            html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>';
            html += '</svg>';
            html += `<span><strong>Début:</strong> ${props.date_debut_formatted} à ${props.heure_debut_formatted}</span>`;
            html += '</div>';
            
            // Date de fin (si présente)
            if (props.date_fin_formatted) {
                html += '<div class="event-tooltip-item">';
                html += '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">';
                html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>';
                html += '</svg>';
                html += `<span><strong>Fin:</strong> ${props.date_fin_formatted} à ${props.heure_fin_formatted}</span>`;
                html += '</div>';
            }
            
            // Créateur
            html += '<div class="event-tooltip-item">';
            html += '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">';
            html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>';
            html += '</svg>';
            html += `<span><strong>Créé par:</strong> ${props.createur_nom}</span>`;
            html += '</div>';
            
            html += '</div>'; // Fin event-tooltip-info
            html += '</div>'; // Fin event-tooltip-content
            
            return html;
        }
        
        // Stocker les instances de tooltip pour pouvoir les détruire
        const tooltipInstances = new Map();
        
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'fr',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth'
            },
            events: calendarEvents,
            eventClick: function(info) {
                // Ouvrir la page de détail
                if (info.event.url) {
                    window.location.href = info.event.url;
                    info.jsEvent.preventDefault();
                }
            },
            eventMouseEnter: function(info) {
                // Créer le tooltip uniquement si l'élément DOM existe
                const el = info.el;
                if (!el) return;
                
                // Détruire l'instance existante si elle existe
                if (tooltipInstances.has(el)) {
                    tooltipInstances.get(el).destroy();
                }
                
                // Créer le contenu du tooltip
                const content = createTooltipContent(info.event);
                
                // Créer l'instance Tippy
                const instance = tippy(el, {
                    content: content,
                    theme: 'event-tooltip',
                    placement: 'top',
                    arrow: true,
                    interactive: false,
                    delay: [200, 0], // Délai d'apparition de 200ms, disparition immédiate
                    duration: [200, 150],
                    allowHTML: true,
                    appendTo: document.body,
                    // Accessibilité
                    role: 'tooltip',
                    aria: {
                        content: 'describedby',
                    },
                });
                
                // Stocker l'instance pour pouvoir la détruire plus tard
                tooltipInstances.set(el, instance);
            },
            eventMouseLeave: function(info) {
                // Le tooltip se ferme automatiquement avec Tippy.js
                // Mais on peut forcer la fermeture si nécessaire
                const el = info.el;
                if (el && tooltipInstances.has(el)) {
                    const instance = tooltipInstances.get(el);
                    instance.hide();
                }
            },
            eventDisplay: 'block',
            height: 'auto',
            navLinks: true,
            dayMaxEvents: true,
            moreLinkClick: 'popover',
        });
        
        calendar.render();
        
        // Nettoyer les tooltips lors du changement de vue
        calendar.on('viewDidMount', function() {
            // Détruire toutes les instances de tooltip existantes
            tooltipInstances.forEach((instance) => {
                instance.destroy();
            });
            tooltipInstances.clear();
        });
    });
</script>
{% endblock %}
{% endblock %}
